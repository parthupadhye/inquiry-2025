/**
 * Tests for <%= className %>.
 *
 * @generated by inquiry-cli
 */

import { describe, it, expect, beforeEach } from 'vitest';
import {
  <%= variableName %>Definition,
  <%= variableName %>Steps,
  <%= variableName %>Parameters,
  type <%= classify(name) %>Input,
} from './<%= name %>.workflow.js';
<% if (withExecutor) { -%>
import { <%= className %>Executor, execute<%= classify(name) %> } from './<%= name %>.executor.js';
<% } -%>

describe('<%= className %>', () => {
  describe('definition', () => {
    it('should have a valid workflow definition', () => {
      expect(<%= variableName %>Definition).toBeDefined();
      expect(<%= variableName %>Definition.id).toBe('<%= name %>');
      expect(<%= variableName %>Definition.name).toBe('<%= className %>');
      expect(<%= variableName %>Definition.version).toMatch(/^\d+\.\d+\.\d+$/);
      expect(<%= variableName %>Definition.status).toBe('active');
    });

    it('should have steps defined', () => {
      expect(<%= variableName %>Steps).toBeDefined();
      expect(Array.isArray(<%= variableName %>Steps)).toBe(true);
<% if (steps.length > 0) { -%>
      expect(<%= variableName %>Steps.length).toBe(<%= steps.length %>);
<% } -%>
    });

    it('should have entry step defined', () => {
      expect(<%= variableName %>Definition.entryStepId).toBeDefined();
<% if (steps.length > 0) { -%>
      const entryStep = <%= variableName %>Steps.find(
        (s) => s.id === <%= variableName %>Definition.entryStepId
      );
      expect(entryStep).toBeDefined();
<% } -%>
    });

    it('should have valid parameters', () => {
      expect(<%= variableName %>Parameters).toBeDefined();
      expect(Array.isArray(<%= variableName %>Parameters)).toBe(true);

      for (const param of <%= variableName %>Parameters) {
        expect(param.name).toBeDefined();
        expect(param.type).toBeDefined();
        expect(typeof param.required).toBe('boolean');
      }
    });

<% for (const step of steps) { -%>
    it('should have <%= step.name %> step', () => {
      const step = <%= variableName %>Steps.find((s) => s.id === '<%= step.id %>');
      expect(step).toBeDefined();
      expect(step?.type).toBe('<%= step.type %>');
      expect(step?.name).toBe('<%= step.name %>');
    });

<% } -%>
  });

<% if (withExecutor) { -%>
  describe('executor', () => {
    let executor: <%= className %>Executor;

    beforeEach(() => {
      executor = new <%= className %>Executor();
    });

    it('should create an executor instance', () => {
      expect(executor).toBeInstanceOf(<%= className %>Executor);
    });

    it('should start workflow execution', async () => {
<% if (preset === 'claim-verification') { -%>
      const input: <%= classify(name) %>Input = {
        content: 'Test content with claims',
        contentType: 'article',
        priority: 3,
      };
<% } else if (preset === 'research') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test research topic',
        scope: 'narrow',
        maxSources: 5,
      };
<% } else if (preset === 'content-generation') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test content topic',
        format: 'article',
        targetLength: 500,
      };
<% } else if (preset === 'validation') { -%>
      const input: <%= classify(name) %>Input = {
        data: { field: 'value' },
        rules: ['required'],
        failFast: false,
      };
<% } else { -%>
      const input: <%= classify(name) %>Input = {
        data: { test: 'value' },
      };
<% } -%>

      const execution = await executor.start(input);

      expect(execution).toBeDefined();
      expect(execution.id).toBeDefined();
      expect(execution.status).toBe('pending');
      expect(execution.workflowId).toBe('<%= name %>');
    });

    it('should execute workflow', async () => {
<% if (preset === 'claim-verification') { -%>
      const input: <%= classify(name) %>Input = {
        content: 'Test content',
      };
<% } else if (preset === 'research') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'content-generation') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'validation') { -%>
      const input: <%= classify(name) %>Input = {
        data: { field: 'value' },
      };
<% } else { -%>
      const input: <%= classify(name) %>Input = {
        data: { test: 'value' },
      };
<% } -%>

      await executor.start(input);
      const result = await executor.execute();

      expect(result).toBeDefined();
      expect(result.executionId).toBeDefined();
      expect(['completed', 'failed']).toContain(result.status);
      expect(result.durationMs).toBeGreaterThanOrEqual(0);
    });

    it('should track execution context', async () => {
<% if (preset === 'claim-verification') { -%>
      const input: <%= classify(name) %>Input = {
        content: 'Test content',
      };
<% } else if (preset === 'research') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'content-generation') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'validation') { -%>
      const input: <%= classify(name) %>Input = {
        data: { field: 'value' },
      };
<% } else { -%>
      const input: <%= classify(name) %>Input = {
        data: { test: 'value' },
      };
<% } -%>

      await executor.start(input);

      const context = executor.getContext();
      expect(context).toBeDefined();
      expect(context?.input).toEqual(input);
      expect(context?.system.workflowId).toBe('<%= name %>');
    });
  });

  describe('execute function', () => {
    it('should execute workflow with convenience function', async () => {
<% if (preset === 'claim-verification') { -%>
      const input: <%= classify(name) %>Input = {
        content: 'Test content',
      };
<% } else if (preset === 'research') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'content-generation') { -%>
      const input: <%= classify(name) %>Input = {
        topic: 'Test topic',
      };
<% } else if (preset === 'validation') { -%>
      const input: <%= classify(name) %>Input = {
        data: { field: 'value' },
      };
<% } else { -%>
      const input: <%= classify(name) %>Input = {
        data: { test: 'value' },
      };
<% } -%>

      const result = await execute<%= classify(name) %>(input);

      expect(result).toBeDefined();
      expect(result.executionId).toBeDefined();
      expect(result.metrics).toBeDefined();
    });
  });
<% } -%>
});
